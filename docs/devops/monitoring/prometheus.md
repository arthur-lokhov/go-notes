---
title: Prometheus
description: Обзор Prometheus, стандарта де-факто для мониторинга и алертинга в облачных окружениях.
---

# Prometheus: Мониторинг и оповещения

!!! abstract "Тезис"
    **Prometheus** — это система мониторинга и оповещения с открытым исходным кодом, изначально созданная в SoundCloud. Она стала стандартом де-факто для мониторинга в мире Kubernetes и облачных приложений благодаря своей pull-модели сбора метрик, мощному языку запросов (PromQL) и интеграции с Grafana.

---

## Ключевые возможности

-   **Многомерная модель данных**: Метрики хранятся в виде временных рядов (time series) с идентификаторами, состоящими из имени метрики и набора пар ключ-значение (лейблов).
-   **Pull-модель**: Prometheus сам опрашивает (scrapes) HTTP-эндпоинты (`/metrics`) на отслеживаемых сервисах для сбора метрик.
-   **PromQL**: Мощный и гибкий язык запросов для анализа временных рядов.
-   **Service Discovery**: Автоматическое обнаружение целей для сбора метрик, включая интеграцию с Kubernetes, Consul и другими системами.
-   **Alertmanager**: Отдельный компонент для управления оповещениями (дедупликация, группировка, отправка в Slack, PagerDuty и т.д.).

---

## Архитектура

!!! example "Схема архитектуры Prometheus"
    ```plaintext
    +-----------------+
    |   Prometheus    |
    | +-------------+ |     +-----------------+
    | | TSDB        | | --> |   Grafana       |
    | +-------------+ |     +-----------------+
    | | Scrape Engine||
    | +-------------+ |     +-----------------+
    | | PromQL Engine| | --> |  Alertmanager   |
    | +-------------+ |     +-----------------+
    +-------+---------+
            |
            | (Pulls /metrics)
    +-------v---------+
    |   Application   |
    | (with /metrics) |
    +-----------------+
    ```

-   **Prometheus Server**: Основной компонент, который собирает, хранит (в своей TSDB) и обрабатывает метрики.
-   **Exporters**: Сторонние утилиты, которые преобразуют метрики из существующих систем (например, базы данных, HAProxy, Redis) в формат Prometheus.
-   **Alertmanager**: Обрабатывает оповещения, сгенерированные Prometheus.
-   **Pushgateway**: Позволяет кратковременным задачам (batch jobs) отправлять свои метрики в Prometheus (push-модель).

---

## Пример запроса PromQL

!!! example "Запрос PromQL"
    ```promql
    # Рассчитать 95-й перцентиль времени ответа HTTP-запросов
    # за последние 5 минут, сгруппированный по пути и методу.
    histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, path, method))
    ```

---

## Преимущества и недостатки

**Преимущества:**
-   **Надежность и простота**: Легко развертывать и обслуживать.
-   **Мощный язык запросов**: PromQL позволяет выполнять сложный анализ данных.
-   **Огромная экосистема**: Множество экспортеров и интеграций.
-   **Стандарт для Kubernetes**: Глубокая интеграция с экосистемой Kubernetes.

**Недостатки:**
-   **Не для логов или трейсинга**: Prometheus предназначен только для метрик.
-   !!! success "Рекомендация: Долгосрочное хранение"
    Для долгосрочного хранения, репликации и глобального просмотра метрик из нескольких кластеров Prometheus используются решения вроде **Thanos**, **Cortex** или **VictoriaMetrics**. **VictoriaMetrics** также является популярной, обратно совместимой с Prometheus системой мониторинга, которая часто используется как drop-in replacement для Prometheus в high-load окружениях благодаря своей производительности и эффективности.
-   **Pull-модель**: Может быть неэффективна в некоторых сценариях (например, для очень короткоживущих задач).
