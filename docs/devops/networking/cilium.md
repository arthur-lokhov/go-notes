---
title: Cilium
description: Глубокое погружение в Cilium, CNI-плагин на базе eBPF для Kubernetes.
---

# Cilium: Сеть, наблюдаемость и безопасность с eBPF

!!! abstract "Тезис"
    **Cilium** — это CNI-плагин с открытым исходным кодом для Kubernetes, который использует **eBPF** для обеспечения высокопроизводительной сети, глубокой наблюдаемости и гранулярной безопасности. Он кардинально меняет подход к управлению трафиком в кластере, отказываясь от `iptables` в пользу более эффективных механизмов ядра Linux.

---

## Ключевые возможности

-   **Сеть на базе eBPF**: Прямая маршрутизация пакетов без `iptables` и `kube-proxy`, что значительно снижает задержки.
-   **Identity-Based Security**: Сетевые политики применяются на основе идентификаторов (identity) сервисов (лейблов), а не IP-адресов, что делает их более гибкими и надежными в динамических окружениях.
-   **Hubble**: Встроенная платформа для наблюдаемости, которая предоставляет детальные карты зависимостей сервисов, метрики и информацию о потоках трафика.
-   **Service Mesh**: Cilium может предоставлять функциональность Service Mesh (балансировка нагрузки, Canary-релизы, шифрование) без необходимости в отдельном sidecar-контейнере (как в Istio).
-   **Поддержка Multi-Cluster**: Позволяет объединять несколько кластеров Kubernetes в единую сеть.

---

## Архитектура

!!! example "Схема архитектуры Cilium"
    ```plaintext
    +--------------------Node 1--------------------+
    | +------------------+   +------------------+ |
    | |      Pod A       |   |      Pod B       | |
    | | (app=frontend)   |   | (app=backend)    | |
    | +--------+---------+   +--------+---------+ |
    |          |                      |
    | +--------v----------------------v---------+ |
    | |              eBPF Programs             | |
    | | (Attached to veth/tc/XDP hooks)        | |
    | +----------------------------------------+ |
    | |              Cilium Agent              | |
    | | (Manages eBPF, policies, identity)     | |
    | +----------------------------------------+ |
    +--------------------------------------------+
    ```

-   **Cilium Agent**: Демон, работающий на каждом узле кластера. Он отвечает за компиляцию и загрузку eBPF-программ в ядро, управление сетевыми политиками и синхронизацию с API-сервером Kubernetes.
-   **eBPF Programs**: Небольшие программы, которые выполняются в ядре и обрабатывают сетевые пакеты. Они реализуют логику маршрутизации, балансировки нагрузки и применения политик.
-   **Hubble**: Состоит из агента на каждом узле и CLI/UI для визуализации данных.

---

## Сетевые политики

Cilium расширяет стандартные `NetworkPolicy` Kubernetes с помощью `CiliumNetworkPolicy` (CRD), которые позволяют создавать более сложные правила:

-   **L7-политики**: Фильтрация трафика на уровне приложений (HTTP, gRPC, Kafka).
-   **DNS-политики**: Разрешение или запрет обращений к определенным DNS-именам.
-   **Политики на основе FQDN**: Правила, основанные на полных доменных именах.

!!! example "Пример CiliumNetworkPolicy"
    ```yaml
    apiVersion: "cilium.io/v2"
    kind: CiliumNetworkPolicy
    metadata:
      name: "api-to-db"
    spec:
      endpointSelector:
        matchLabels:
          app: db
      ingress:
      - fromEndpoints:
        - matchLabels:
            app: api
        toPorts:
        - ports:
          - port: "5432"
            protocol: TCP
    ```
    Эта политика разрешает входящий трафик на порт `5432` для подов с лейблом `app: db` только от подов с лейблом `app: api`.

---

## Преимущества и недостатки

**Преимущества:**
-   **Производительность**: Значительно быстрее, чем решения на базе `iptables`.
-   **Наблюдаемость**: Hubble предоставляет уникальные возможности для анализа трафика.
-   **Безопасность**: Гранулярные L3/L4/L7 политики и identity-based подход.

**Недостатки:**
-   **Требования к ядру**: Требует относительно свежей версии ядра Linux с поддержкой eBPF.
-   **Сложность**: Порог вхождения может быть выше, чем у более простых CNI (например, Flannel).
