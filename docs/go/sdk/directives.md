# Директивы в Go

!!! info

    Директивы `//go:` — это специальные комментарии, которые дают указания компилятору и другим инструментам Go.

## Директивы компилятора

### `//go:noinline`

```go
//go:noinline
func expensiveCalculation() int {
    // Сложные вычисления
}
```

#### Что делает

Запрещает инлайнинг функции.

#### Когда использовать

Когда нужно точно измерять производительность конкретной функции или предотвратить оптимизацию.

### `//go:nosplit`

```go
//go:nosplit
func criticalLowLevelFunction() {
    // Код, который должен работать с минимальным стеком
}
```

#### Что делает

Запрещает разделение стека (stack splitting).

#### Когда использовать

В низкоуровневом коде (например, в рантайме или системных вызовах).

### `//go:noescape`

```go
//go:noescape
func sum(x, y int) int
```

#### Что делает

Указывает, что параметры функции не "убегают" в кучу.

#### Когда использовать

Для оптимизации производительности в критических путях.

### `//go:norace`

```go
//go:norace
func init() {
    // Инициализация, которая выглядит как гонка данных, но безопасна
}
```

#### Что делает

Отключает детектирование гонок данных для функции.

#### Когда использовать

Только для специальных случаев, когда вы уверены в отсутствии гонок.

### `//go:yeswritebarrierrec`

```go
//go:yeswritebarrierrec
func recursiveFunction() {
    // ...
}
```

#### Что делает

Разрешает write barrier в рекурсивных функциях.

#### Когда использовать

В сложных случаях работы со сборщиком мусора.

## Директивы линкера

### `//go:build`

```go
//go:build linux && amd64
package main
```

#### Что делает

Условная компиляция (заменила `// +build` в Go 1.17+).
Поддерживает булевы выражения (&&, ||, !, скобки).

### `//go:linkname`

```go
//go:linkname localName package.remoteName
```

```go
//go:linkname now time.now
func now() (sec int64, nsec int32, mono int64)
```

#### Что делает

Создает ссылку на неэкспортированный символ.

#### Когда использовать

Для интеграции с внутренними компонентами Go, требует файл `import _ "unsafe"`.

## Директивы управления памятью

### `//go:uintptrescapes`

```go
//go:uintptrescapes
func syscallWrapper(addr uintptr)
```

#### Что делает

Указывает, что `uintptr` параметры могут содержать "убежавшие" указатели.

#### Когда использовать

При работе с системными вызовами через `uintptr`.

### `//go:notinheap`

```go
//go:notinheap
type internalStruct struct {
    // поля
}
```

#### Что делает

Помечает тип как не размещаемый в куче.

#### Когда использовать

В runtime и низкоуровневых компонентах.

## Директивы сборщика мусора

### `//go:nowritebarrier`

```go
//go:nowritebarrier
func gcCriticalFunction() {
    // ...
}
```

#### Что делает

Запрещает write barrier в функции.

#### Когда использовать

В критических секциях сборщика мусора.

### `//go:nowritebarrierrec`

```go
//go:nowritebarrierrec
func gcMarkWorker() {
    // ...
}
```

#### Что делает

Запрещает write barrier в функции и всех вызываемых ею функциях.

#### Когда использовать

Для сложных случаев в реализации GC.

## Директивы для ассемблера

### `//go:noescape` (для ассемблера)

```go
//go:noescape
func ·Add(SB),NOSPLIT,$0
```

#### Что делает

Аналогично версии для Go, но для ассемблерных функций.

### `//go:nosplit` (для ассемблера)

```go
//go:nosplit
func ·Syscall(SB),NOSPLIT,$0
```

#### Что делает

Аналогично версии для Go, но для ассемблерных функций.

## Другие директивы

### `//go:generate`

```go
//go:generate stringer -type=Pill
type Pill int
```

#### Что делает

Указывает команду для `go generate`.

#### Когда использовать

Для автоматической генерации кода.

### `//go:embed`

```go
//go:embed hello.txt
var s string
```

#### Что делает

Встраивает файлы в бинарник (с Go 1.16+).