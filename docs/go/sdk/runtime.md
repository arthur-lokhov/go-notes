# Runtime в Go

!!! info

    Runtime — это набор системных компонентов, которые обеспечивают выполнение Go-программ.
    Он включает в себя управление памятью, планирование горутин, работу с системными вызовами и другие низкоуровневые операции.

## Основные компоненты runtime

### Планировщик (Scheduler)

- Управляет выполнением горутин
- Использует M:N модель (много горутин на небольшом количестве потоков ОС)
- Реализует кооперативную многозадачность с вытеснением

### Сборщик мусора (Garbage Collector)

- Автоматическое управление памятью
- Параллельный трехцветный маркировочный алгоритм
- Низколатентный (обычно <1ms паузы)

### Система памяти

- Быстрые аллокации через per-P кэши
- Эффективное управление кучей
- Интеграция со сборщиком мусора

## Внутреннее устройство runtime

### Модель G-P-M

1. **G (Goroutine)** - легковесный поток.
2. **P (Processor)** - логический процессор.
3. **M (Machine)** - поток ядра ОС.

### Управление памятью

1. Разделение на tiny, small и large объекты
2. Per-P кэши для быстрых аллокаций
3. Инкрементальная очистка кучи

### Сетевой поллинг

1. Использует эффективные системные вызовы (epoll, kqueue)
2. Интеграция с планировщиком

## Пакет `runtime`

!!! info

    Пакет `runtime` предоставляет функции для взаимодействия с Go runtime.

### Основные функции

#### Управление горутинами

```go
func GOMAXPROCS(n int) int  // Устанавливает максимальное количество CPU
func NumGoroutine() int     // Текущее количество горутин
func Goexit()               // Завершает текущую горутину
```

#### Работа с памятью

```go
func GC()                   // Принудительный запуск сборщика мусора
func ReadMemStats(m *MemStats) // Статистика использования памяти
```

#### Системная информация

```go
func NumCPU() int           // Количество логических CPU
func OS() string            // Имя ОС (linux, windows и т.д.)
func Arch() string          // Архитектура (amd64, arm и т.д.)
```

#### Управление стеком

```go
func Stack(buf []byte, all bool) int // Получить стек вызовов
```

### Практическое использование

#### Анализ использования памяти

```go
var m runtime.MemStats
runtime.ReadMemStats(&m)
fmt.Printf("Alloc = %v MiB", m.Alloc/1024/1024)
```

#### Управление горутинами

```go
// Ограничение использования CPU
runtime.GOMAXPROCS(4)

// Получение информации о горутинах
fmt.Println("Goroutines:", runtime.NumGoroutine())
```

#### Профилирование

```go
// Запись профиля CPU
f, _ := os.Create("cpu.prof")
pprof.StartCPUProfile(f)
defer pprof.StopCPUProfile()

// Запись профиля памяти
f, _ := os.Create("mem.prof")
pprof.WriteHeapProfile(f)
f.Close()
```